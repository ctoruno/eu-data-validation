---
title: '`r params$country` Validation Report'
author: "Dalia Habiby"
date: "2023-10-27"
output:
  html_document: default
params:
  country: Greece
---

```{r setup, echo = F}
#add to gpp folder to make sure everyone has access
suppressMessages(library(tidyverse))
suppressMessages(library(haven))
suppressMessages(library(caret))
suppressMessages(library(rio))
suppressMessages(library(kableExtra))
knitr::opts_chunk$set(echo = F)

df<- import_list(paste0("./Outcomes/Pretest/", params$country, "/", params$country, ".xlsx"))
source("paragraph.R")
par<- paragraph(params$country)
```


```{r}
threshold<- df$tps_comparisson
time<- df$time_changes

time<- time%>%
  select(-tpsvars)

experts<- threshold%>%
  filter(Type_Survey == "expert")
threshold<- threshold%>%
  filter(Type_Survey == "population")
```

```{r}
# Threshold Analysis for population polls
flags<- threshold%>%
  group_by(Pillar)%>%
  count(Flag)

problematic<- c()
notproblematic<- c()

for (p in unique(threshold$Pillar)){
  
  pillar<- flags%>%
    filter(Pillar == p)
  
  sp<- sum(pillar$n)
  
  
  if ("red" %in% unique(pillar$Flag)){
  
    if (pillar$n[pillar$Flag == "red"]/sp >= 0.5){
      
      problematic<- c(problematic, p)
    
    } else if ( (pillar$n[pillar$Flag == "red"] + pillar$n[pillar$Flag == "yellow"])/sp >= 0.75){
    
      problematic<- c(problematic, p)
      
  }
    else {
      notproblematic<- c(notproblematic, p)

  }
    
  }
  
  else if ("yellow" %in% unique(pillar$Flag)){
    
    if (pillar$n[pillar$Flag == "yellow"]/sp >= 0.75){
      
      problematic<- c(problematic, p)

    }
    else {
      notproblematic<- c(notproblematic, p)

  }
  
  }
  else {
    notproblematic<- c(notproblematic, p)

  }
  
}

clevel<- c()

if (length(problematic) >= length(c(problematic, notproblematic))/2){
  clevel<-c(clevel, 1)
} else {
  
  clevel<- c(clevel,0)
}



problematicth<- sort(problematic)


```

```{r}
#Threshold analysis for expert surveys
flags2<- experts%>%
  group_by(Pillar)%>%
  count(Flag)

problematic<- c()
notproblematic<- c()

for (p in unique(experts$Pillar)){
  
  pillar <- flags2%>%
    filter(Pillar == p)
  
  sp <- sum(pillar$n)
  
  
  if ("red" %in% unique(pillar$Flag)){
  
    if (pillar$n[pillar$Flag == "red"]/sp >= 0.5){
      
      problematic <- c(problematic, p)
    
    } else if ( (pillar$n[pillar$Flag == "red"] + pillar$n[pillar$Flag == "yellow"])/sp >= 0.75){
    
      problematic<- c(problematic, p)
      
  }
    else {
      notproblematic<- c(notproblematic, p)

  }
    
  } else if ("yellow" %in% unique(pillar$Flag)){
    
    if (pillar$n[pillar$Flag == "yellow"]/sp >= 0.75){
      
      problematic<- c(problematic, p)

    } else {
      notproblematic<- c(notproblematic, p)

  }
  
  } else {
    notproblematic<- c(notproblematic, p)

  }
  
}


if (length(problematic) >= length(c(problematic, notproblematic))/2){
  clevel<-c(clevel, 1)
} else {
  
  clevel<- c(clevel,0)
}



problematicex<- sort(problematic)


```



```{r}
# Time change analysis


warnings<- time%>%
  group_by(pillar)%>%
  count(warning)

problematic<- c()
notproblematic<- c()

for (p in unique(time$pillar)){
  
  pillar<- warnings%>%
    filter(pillar == p)
  
  sp<- sum(pillar$n)
  
  
  if ("Red light" %in% unique(pillar$warning)){
  
    if (pillar$n[pillar$warning == "Red light"]/sp >= 0.5 ){
      
      problematic<- c(problematic, p)
    
    }
    
    else if ("Yellow light" %in% unique(pillar$warning)){
      
      if ((pillar$n[pillar$warning == "Red light"] + pillar$n[pillar$warning == "Yellow light"])/sp >= 0.75){
        
        problematic<- c(problematic, p)
        
      }
      else {
        notproblematic<- c(notproblematic, p)
        
      }
    }
    
  }
  
  else if ("Yellow light" %in% unique(pillar$warning)){
    
    if (pillar$n[pillar$warning == "Yellow light"]/sp >= 0.75){
      
      problematic<- c(problematic, p)

    }
    else {
      notproblematic<- c(notproblematic, p)

  }
  
  }
  else {
    notproblematic<- c(notproblematic, p)

  }
  
}

if (length(problematic) >= length(c(problematic, notproblematic))/2){
  clevel<-c(clevel, 1)
} else {
  
  clevel<- c(clevel,0)
}

problematictt<- sort(problematic)
```



```{r}
#Country overall

if (clevel[[1]] == 1 & clevel[[3]] == 1){
  
  probl<- "significantly different from both the previous GPP and the Third Party Sources"
  rec<- paste0("we recommend to check the indicators in pillar(s) ", paste(problematictt, sep="", collapse=", "), " in the t-test analysis and pillar(s) ", paste(problematicth, sep="", collapse=", "), " in the threshold analysis.")
  
} else if (clevel[[1]] == 1 & clevel[[3]] == 0) {
  probl<- "significantly different from only the Third Party Sources"
  rec<- paste0("we recommend to check the indicators in pillar(s) ", paste(problematicth, sep="", collapse=", "), " in the threshold analysis.")
  
} else if (clevel[[1]] == 0 & clevel[[3]] == 1){
  probl<- "significantly different from only the previous GPP"
  rec<- paste0("we recommend to check the indicators in pillar(s) ", paste(problematictt, sep="", collapse=", "), " in the t-test analysis.")
  
} else if (clevel[[1]] == 0 & clevel[[3]] == 0){
  probl<- "not significantly different from the previous GPP or the Third Party Sources"
  rec<- "we recommend that the EU GPP team continue monitoring and make note of any other concern"
  
}
```

# Report {.tabset}

## Guidelines

**Overview**

The goal of this document is to facilitate the evaluation of concern for extreme issues in the survey.
  
We want to preserve the validation review process that has been implemented in the past by the GPP team, while also providing more structure and a quicker way to identify potential issues. Instead of keeping track of multiple files and documents on your device, all of the relevant information lives in one dynamic platform. 
  
Our analyses are built to only identify cases of highly significant differences from our previous data as well as third party source data. We also acknowledge that many indicators are expected to change over time, or change when asked in a different way in another survey. Furthermore, our data is limited by the number of matches that can successfully be drawn from the EU GPP questionnaire to the Global GPP or to a Third Party Source. Ultimately, given these circumstances, it will still be up to the discretion of the GPP team about what and how they would like to communicate with the survey companies.
  
**Analyses**
  
Each country is evaluated based on three analyses: one internal, another external, and the last one structural. 
  
The internal and external analyses are based on a flagging system which is explained below:
  
The first analysis is a t-test between a subset of EU GPP indicators and their counterparts from the latest Global GPP per country. 
  
We define a pillar as "significantly different" in the t-test analysis in one of two cases:
  
1. If 50% or more of the indicators have a statistically significant difference from our last GPP with a p-value below 0.01 (red flag)
  
2. If 75% or more of the indicators have a statistically significant difference from our last GPP with a p-value below 0.1 (yellow flag)
  
The second is a threshold difference between a few EU GPP indicators and their matched third party source indicators for each sub-pillar. 
  
We define a pillar as "significantly different" in the threshold analysis in one of two cases:
  
1. If 50% or more of the indicators have a threshold difference above 0.30 (red flag), or
  
2. If 75% or more of the indicators have a threshold difference above 0.15 (yellow flag)
  
In both of these tests, we flag the country as a whole if at lease half of the Pillars evaluated are labelled "significantly different." If the country is labelled "significantly different" in both tests, then we find cause for concern. 
  
**Process**
  
In order to utilize this document to the fullest, we suggest navigating to the "Country Level Findings" tab to view a summary of which Pillars in which analyses are concerning. From there, if any of the Pillars are significantly different, you can investigate further in the "Appendix" tab. Under the Appendix, you can select the Pillar of interest and view the analysis results as well as contextual information for each indicator that we tested. Based on the flags in the tables, it may be necessary to proceed with qualitative research to determine if the significant changes are unexpected, and therefore troublesome. 
  
Overall, this platform is a tool to help accelerate the process of identifying possible issues that should be further investigated.

## Country Level Findings {.tabset}

**We have found that the data from `r params$country` is `r probl`.**

`r par`

Since the data from `r params$country` is overall `r probl`, `r rec`



```{r}
flagsoutput<- flags%>%
  pivot_wider(names_from = Flag, values_from = n)

flagsoutput[is.na(flagsoutput)] <- 0
  
flagsoutput<- flagsoutput%>%
  mutate(sum = green + red + yellow )%>%
  select(Pillar, green, yellow, red, sum)

flagsoutput$Label<- ifelse(flagsoutput$red >= flagsoutput$sum/2, "Significantly Different", ifelse(flagsoutput$red+flagsoutput$yellow >= 3*flagsoutput$sum/4, "Significantly Different", ifelse(flagsoutput$yellow >= 3*flagsoutput$sum/4, "Significantly Different", "Not Significantly Different")))


colnames(flagsoutput)<- c("Pillar", "Green Flags", "Yellow Flags", "Red Flags", "Total Indicators", "Label")



```

```{r}
flagsoutput2<- flags2%>%
  pivot_wider(names_from = Flag, values_from = n)

flagsoutput2[is.na(flagsoutput2)] <- 0
  
flagsoutput2<- flagsoutput2%>%
  mutate(sum = green + red + yellow )%>%
  select(Pillar, green, yellow, red, sum)

flagsoutput2$Label<- ifelse(flagsoutput2$red >= flagsoutput2$sum/2, "Significantly Different", ifelse(flagsoutput2$red+flagsoutput2$yellow >= 3*flagsoutput2$sum/4, "Significantly Different", ifelse(flagsoutput2$yellow >= 3*flagsoutput2$sum/4, "Significantly Different", "Not Significantly Different")))


colnames(flagsoutput2)<- c("Pillar", "Green Flags", "Yellow Flags", "Red Flags", "Total Indicators", "Label")
```



```{r}
warningsoutput<- warnings%>%
  pivot_wider(names_from = warning, values_from = n)

warningsoutput[is.na(warningsoutput)] <- 0
  
warningsoutput<- warningsoutput%>%
  mutate(sum = `Green light` + `Red light` + `Yellow light`)%>%
  select(pillar, `Green light`, `Yellow light`, `Red light`, sum)

warningsoutput$Label<- ifelse(warningsoutput$`Red light` >= warningsoutput$sum/2, "Significantly Different", ifelse(warningsoutput$`Red light`+warningsoutput$`Yellow light` >= 3*warningsoutput$sum/4, "Significantly Different", ifelse(warningsoutput$`Yellow light` >= 3*warningsoutput$sum/4, "Significantly Different", "Not Significantly Different")))


colnames(warningsoutput)<- c("Pillar", "Green Flags", "Yellow Flags", "Red Flags", "Total Indicators", "Label")

```

Below are three tables summarizing each of the validation analyses to provide further details about the issues we have flagged. If you are interested in exploring which specific variables are flagged, please see the Appendix.
  

### Internal Validation (T-Test Analysis)
  
Since the t-test analysis this year is comparing to the previous Global GPP, there are some indicators that are new this year and do not match with the Global indicators. Therefore, there are less indicators evaluated in this analysis than the threshold analysis. Additionally, we expect many of our indicators to change in significant ways as the world changes. Therefore, it is up to the discretion of the EU GPP team whether or not the t-test results are concerning.

```{r}
knitr::kable(warningsoutput, caption = "T-Test Analysis Summary")%>%
  kable_classic(html_font = "Arial")%>%
  kable_styling(bootstrap_options = c("striped"))
```


### External Validation (Threshold Analysis with Population Polls)
Given the nature of third party sources, there are a limited number of external indicators that match with our EU GPP indicators. As of now, we do not have any matches for Pillar 6. Furthermore, all of the third party indicators may not be available for each country and thus the percentage of problematic indicators in each Pillar may vary. 



```{r}
knitr::kable(flagsoutput, caption = "Threshold Analysis Summary")%>%
  kable_classic(html_font = "Arial")%>%
  kable_styling(bootstrap_options = c("striped"))

```
  
  
### External Validation (Threshold Analysis with Expert Surveys)
Given the nature of third party sources, there are a limited number of external indicators that match with our EU GPP indicators. As of now, we do not have any matches for Pillar 6. Furthermore, all of the third party indicators may not be available for each country and thus the percentage of problematic indicators in each Pillar may vary. 



```{r}
knitr::kable(flagsoutput2, caption = "Threshold Analysis Summary")%>%
  kable_classic(html_font = "Arial")%>%
  kable_styling(bootstrap_options = c("striped"))

```


## Appendix {.tabset}

Each tab below holds the full information for each analysis for each pillar in order to facilitate the evaluation of the results. At the moment, we do not have any matches in Pillar 6, and therefore there are no analysis tables for Pillar 6. Furthermore, there are no previous index matches for Pillar 5, and thus the table for the T-Test in Pillar 5 is empty.

```{r}
# th<- threshold%>%
#   select(Country, GPP_Variable_Name, Flag, Pillar, Sub_Pillar)
# tt<- time2%>%
#   select(variable, warning)
 codebook<- import_list("../Input/EU2 GPP 2023 Codebook.xlsx")
 cb<- codebook$Codebook
 
 cb2<-cb%>%
   select(Variable, `2023  EU Questionnaire`, Description)
# 
# 
# 
# appendix<- left_join(th, tt, by = join_by("GPP_Variable_Name"== variable), relationship = "many-to-many")
# appendix <- merge(appendix, cb2, by.x="GPP_Variable_Name", by.y =  "Variable", all.x = TRUE)
# 
# appendix<- appendix%>%
#   select(Country, `2023  EU Questionnaire`, Description, Flag, warning, Pillar, Sub_Pillar)%>%
#   distinct()%>%
#   arrange(`2023  EU Questionnaire`, Pillar)
# 
# appendix$Flag<- ifelse(appendix$Flag == "red", "Red", ifelse(appendix$Flag == "yellow", "Yellow", ifelse(appendix$Flag == "green", "Green", "Not Assessed")))
# appendix$warning<- ifelse(appendix$warning == "Red light", "Red", ifelse(appendix$warning == "Yellow light", "Yellow", ifelse(appendix$warning == "Green light", "Green", "Not Assessed")))
# 
# colnames(appendix)<- c("Country", "GPP Variable", "Question Text", "Flag Threshold", "Flag T-Test", "Pillar", "Sub-Pillar")


```


```{r}
appendixth <- merge(threshold, cb2, by.x="GPP_Variable_Name", by.y =  "Variable", all.x = TRUE)

a<- appendixth%>%
  select(Sub_Pillar, `2023  EU Questionnaire`, Flag, Description, TPS_Question, TPS_Source, TPS_Year, GPP_datapoint, TPS_datapoint, Difference,  Pillar )%>%
  arrange(Sub_Pillar)
a$Flag<- ifelse(a$Flag == "red", "Red", ifelse(a$Flag == "green", "Green", ifelse(a$Flag == "yellow", "Yellow", NA)))

colnames(a)<- c("Sub Pillar", "GPP Indicator", "Flag", "GPP Question",  "TPS Question", "TPS Source", "TPS Year", "GPP Score", "TPS Score", "Difference", "Pillar")

appendixex <- merge(experts, cb2, by.x="GPP_Variable_Name", by.y =  "Variable", all.x = TRUE)

e<- appendixex%>%
  select(Sub_Pillar, `2023  EU Questionnaire`, Flag, Description, TPS_Question, TPS_Source, TPS_Year, GPP_datapoint, TPS_datapoint, Difference,  Pillar )%>%
  arrange(Sub_Pillar)
e$Flag<- ifelse(e$Flag == "red", "Red", ifelse(e$Flag == "green", "Green", ifelse(e$Flag == "yellow", "Yellow", NA)))

colnames(e)<- c("Sub Pillar", "GPP Indicator", "Flag", "GPP Question",  "TPS Question", "TPS Source", "TPS Year", "GPP Score", "TPS Score", "Difference", "Pillar")


appendixtt <- merge(time, cb2, by.x="variable", by.y =  "Variable", all.x = TRUE)

b<- appendixtt%>%
  select(subpillar, `2023  EU Questionnaire`, warning, Description, prev_year, previous_score, current_score, ttestResult, direction, pillar )%>%
  arrange(subpillar)

colnames(b)<- c("Sub Pillar", "GPP Indicator", "Flag", "GPP Question", "Comparison Year", "Previous Score", "Current Score", "P value",  "Direction", "Pillar" )

b$Flag<- ifelse(b$Flag == "Red light", "Red", ifelse(b$Flag == "Green light", "Green", ifelse(b$Flag == "Yellow light", "Yellow", NA)))

```


```{r}
ttestex<- "In the T-test, a red flag indicates statistical significance with a p-value of 0.01. A yellow flag indicates statistical significance with a p-value between 0.01 and 0.1. A green flag indicates statistical significance only with a p-value greater than 0.1, or no statistical significance."

threshex<- "In the threshold difference, a red flag indicates a difference of 0.30 or more. A yellow flag indicates a difference between 0.15 and 0.30. A green flag indicates a difference of less than 0.10. DISCLAIMER: some large differences may be caused by low matches between the content of the GPP and TPS questions. Make sure to account for how similar (or dissimilar) each pair is when performing qualitative checks."
```


### Pillar 1 {.tabset}

#### T-Test (Internal) Analysis

`r ttestex`

```{r}
b2<- b%>%
  filter(Pillar == "1: Constraints on Government Powers")%>%
  select(-Pillar)
b2$Flag = cell_spec(b2$Flag, color = ifelse(b2$Flag == "Green", "green", ifelse(b2$Flag == "Red", "red", "gold")))

knitr::kable(b2, caption = "Variable List and Flags", booktabs = T, escape = F, digits=3)%>%
  kable_classic(html_font = "Arial", )%>%
  kable_styling(bootstrap_options = c("striped"), full_width = T)
```


#### Population Threshold (External) Analysis

`r threshex`

```{r}
a2<- a%>%
  filter(Pillar == "1: Constraints on Government Powers")%>%
  select(-Pillar)

a2$Flag = cell_spec(a2$Flag, color = ifelse(a2$Flag == "Green", "green", ifelse(a2$Flag == "Red", "red", "gold")))


knitr::kable(a2, caption = "Variable List and Flags", booktabs = T, escape = F, digits=3)%>%
  kable_classic(html_font = "Arial", )%>%
  kable_styling(bootstrap_options = c("striped"), full_width = T)
  
```

#### Experts Threshold (External) Analysis

`r threshex`

```{r}
e2<- e%>%
  filter(Pillar == "1: Constraints on Government Powers")%>%
  select(-Pillar)

e2$Flag = cell_spec(e2$Flag, color = ifelse(e2$Flag == "Green", "green", ifelse(e2$Flag == "Red", "red", "gold")))


knitr::kable(e2, caption = "Variable List and Flags", booktabs = T, escape = F, digits=3)%>%
  kable_classic(html_font = "Arial", )%>%
  kable_styling(bootstrap_options = c("striped"), full_width = T)
  
```


### Pillar 2 {.tabset}

#### T-Test (Internal) Analysis

`r ttestex`

```{r}
b2<- b%>%
  filter(Pillar == "2: Absence of Corruption")%>%
  select(-Pillar)
b2$Flag = cell_spec(b2$Flag, color = ifelse(b2$Flag == "Green", "green", ifelse(b2$Flag == "Red", "red", "gold")))

knitr::kable(b2, caption = "Variable List and Flags", booktabs = T, escape = F, digits=3)%>%
  kable_classic(html_font = "Arial", )%>%
  kable_styling(bootstrap_options = c("striped"), full_width = T)
```


#### Population Threshold (External) Analysis

`r threshex`

```{r}
a2<- a%>%
  filter(Pillar == "2: Absence of Corruption")%>%
  select(-Pillar)

a2$Flag = cell_spec(a2$Flag, color = ifelse(a2$Flag == "Green", "green", ifelse(a2$Flag == "Red", "red", "gold")))


knitr::kable(a2, caption = "Variable List and Flags", booktabs = T, escape = F, digits=3)%>%
  kable_classic(html_font = "Arial", )%>%
  kable_styling(bootstrap_options = c("striped"), full_width = T)
  
```

#### Experts Threshold (External) Analysis

`r threshex`

```{r}
e2<- e%>%
  filter(Pillar == "2: Absence of Corruption")%>%
  select(-Pillar)

e2$Flag = cell_spec(e2$Flag, color = ifelse(e2$Flag == "Green", "green", ifelse(e2$Flag == "Red", "red", "gold")))


knitr::kable(e2, caption = "Variable List and Flags", booktabs = T, escape = F, digits=3)%>%
  kable_classic(html_font = "Arial", )%>%
  kable_styling(bootstrap_options = c("striped"), full_width = T)
  
```

### Pillar 3 {.tabset}

#### T-Test (Internal) Analysis

`r ttestex`

```{r}
b2<- b%>%
  filter(Pillar == "3: Open Government")%>%
  select(-Pillar)
b2$Flag = cell_spec(b2$Flag, color = ifelse(b2$Flag == "Green", "green", ifelse(b2$Flag == "Red", "red", "gold")))

knitr::kable(b2, caption = "Variable List and Flags", booktabs = T, escape = F, digits=3)%>%
  kable_classic(html_font = "Arial", )%>%
  kable_styling(bootstrap_options = c("striped"), full_width = T)
```


#### Population Threshold (External) Analysis

`r threshex`

```{r}
a2<- a%>%
  filter(Pillar == "3: Open Government")%>%
  select(-Pillar)

a2$Flag = cell_spec(a2$Flag, color = ifelse(a2$Flag == "Green", "green", ifelse(a2$Flag == "Red", "red", "gold")))


knitr::kable(a2, caption = "Variable List and Flags", booktabs = T, escape = F, digits=3)%>%
  kable_classic(html_font = "Arial", )%>%
  kable_styling(bootstrap_options = c("striped"), full_width = T)
  
```

#### Experts Threshold (External) Analysis

`r threshex`

```{r}
e2<- e%>%
  filter(Pillar == "3: Open Government")%>%
  select(-Pillar)

e2$Flag = cell_spec(e2$Flag, color = ifelse(e2$Flag == "Green", "green", ifelse(e2$Flag == "Red", "red", "gold")))


knitr::kable(e2, caption = "Variable List and Flags", booktabs = T, escape = F, digits=3)%>%
  kable_classic(html_font = "Arial", )%>%
  kable_styling(bootstrap_options = c("striped"), full_width = T)
  
```

### Pillar 4 {.tabset}

#### T-Test (Internal) Analysis

`r ttestex`

```{r}
b2<- b%>%
  filter(Pillar == "4: Fundamental Rights")%>%
  select(-Pillar)
b2$Flag = cell_spec(b2$Flag, color = ifelse(b2$Flag == "Green", "green", ifelse(b2$Flag == "Red", "red", "gold")))

knitr::kable(b2, caption = "Variable List and Flags", booktabs = T, escape = F, digits=3)%>%
  kable_classic(html_font = "Arial", )%>%
  kable_styling(bootstrap_options = c("striped"), full_width = T)
```


#### Population Threshold (External) Analysis

`r threshex`

```{r}
a2<- a%>%
  filter(Pillar == "4: Fundamental Rights")%>%
  select(-Pillar)

a2$Flag = cell_spec(a2$Flag, color = ifelse(a2$Flag == "Green", "green", ifelse(a2$Flag == "Red", "red", "gold")))


knitr::kable(a2, caption = "Variable List and Flags", booktabs = T, escape = F, digits=3)%>%
  kable_classic(html_font = "Arial", )%>%
  kable_styling(bootstrap_options = c("striped"), full_width = T)
  
```


#### Experts Threshold (External) Analysis

`r threshex`

```{r}
e2<- e%>%
  filter(Pillar == "4: Fundamental Rights")%>%
  select(-Pillar)

e2$Flag = cell_spec(e2$Flag, color = ifelse(e2$Flag == "Green", "green", ifelse(e2$Flag == "Red", "red", "gold")))


knitr::kable(e2, caption = "Variable List and Flags", booktabs = T, escape = F, digits=3)%>%
  kable_classic(html_font = "Arial", )%>%
  kable_styling(bootstrap_options = c("striped"), full_width = T)
  
```

### Pillar 5 {.tabset}

#### T-Test (Internal) Analysis

`r ttestex`

```{r}
b2<- b%>%
  filter(Pillar == "5: Order and Security")%>%
  select(-Pillar)

b2$Flag = cell_spec(b2$Flag, color = ifelse(b2$Flag == "Green", "green", ifelse(b2$Flag == "Red", "red", "gold")))

knitr::kable(b2, caption = "Variable List and Flags", booktabs = T, escape = F, digits=3)%>%
  kable_classic(html_font = "Arial", )%>%
  kable_styling(bootstrap_options = c("striped"), full_width = T)
```


#### Population Threshold (External) Analysis {.tabset}

`r threshex`

```{r}
a2<- a%>%
  filter(Pillar == "5: Order and Security")%>%
  select(-Pillar)

a2$Flag = cell_spec(a2$Flag, color = ifelse(a2$Flag == "Green", "green", ifelse(a2$Flag == "Red", "red", "gold")))


knitr::kable(a2, caption = "Variable List and Flags", booktabs = T, escape = F, digits=3)%>%
  kable_classic(html_font = "Arial", )%>%
  kable_styling(bootstrap_options = c("striped"), full_width = T)
  
```


#### Experts Threshold (External) Analysis

`r threshex`

```{r}
e2<- e%>%
  filter(Pillar == "5: Order and Security")%>%
  select(-Pillar)

#e2$Flag = cell_spec(e2$Flag, color = ifelse(e2$Flag == "Green", "green", ifelse(e2$Flag == "Red", "red", "gold")))


knitr::kable(e2, caption = "Variable List and Flags", booktabs = T, escape = F, digits=3)%>%
  kable_classic(html_font = "Arial", )%>%
  kable_styling(bootstrap_options = c("striped"), full_width = T)
  
```

### Pillar 7 {.tabset}

#### T-Test (Internal) Analysis

`r ttestex`

```{r}
b2<- b%>%
  filter(Pillar == "7: Civil Justice")%>%
  select(-Pillar)
b2$Flag = cell_spec(b2$Flag, color = ifelse(b2$Flag == "Green", "green", ifelse(b2$Flag == "Red", "red", "gold")))

knitr::kable(b2, caption = "Variable List and Flags", booktabs = T, escape = F, digits=3)%>%
  kable_classic(html_font = "Arial", )%>%
  kable_styling(bootstrap_options = c("striped"), full_width = T)
```


#### Population Threshold (External) Analysis {.tabset}

`r threshex`

```{r}
a2<- a%>%
  filter(Pillar == "7: Civil Justice")%>%
  select(-Pillar)

a2$Flag = cell_spec(a2$Flag, color = ifelse(a2$Flag == "Green", "green", ifelse(a2$Flag == "Red", "red", "gold")))


knitr::kable(a2, caption = "Variable List and Flags", booktabs = T, escape = F, digits=3)%>%
  kable_classic(html_font = "Arial", )%>%
  kable_styling(bootstrap_options = c("striped"), full_width = T)
  
```


#### Experts Threshold (External) Analysis

`r threshex`

```{r}
e2<- e%>%
  filter(Pillar == "7: Civil Justice")%>%
  select(-Pillar)

e2$Flag = cell_spec(e2$Flag, color = ifelse(e2$Flag == "Green", "green", ifelse(e2$Flag == "Red", "red", "gold")))


knitr::kable(e2, caption = "Variable List and Flags", booktabs = T, escape = F, digits=3)%>%
  kable_classic(html_font = "Arial", )%>%
  kable_styling(bootstrap_options = c("striped"), full_width = T)
  
```

### Pillar 8 {.tabset}

#### T-Test (Internal) Analysis

`r ttestex`

```{r}
b2<- b%>%
  filter(Pillar == "8: Criminal Justice")%>%
  select(-Pillar)
b2$Flag = cell_spec(b2$Flag, color = ifelse(b2$Flag == "Green", "green", ifelse(b2$Flag == "Red", "red", "gold")))

knitr::kable(b2, caption = "Variable List and Flags", booktabs = T, escape = F, digits=3)%>%
  kable_classic(html_font = "Arial", )%>%
  kable_styling(bootstrap_options = c("striped"), full_width = T)
```


#### Population Threshold (External) Analysis

`r threshex`

```{r}
a2<- a%>%
  filter(Pillar == "8: Criminal Justice")%>%
  select(-Pillar)

a2$Flag = cell_spec(a2$Flag, color = ifelse(a2$Flag == "Green", "green", ifelse(a2$Flag == "Red", "red", "gold")))


knitr::kable(a2, caption = "Variable List and Flags", booktabs = T, escape = F, digits=3)%>%
  kable_classic(html_font = "Arial", )%>%
  kable_styling(bootstrap_options = c("striped"), full_width = T)
  
```

#### Experts Threshold (External) Analysis

`r threshex`

```{r}
e2<- e%>%
  filter(Pillar == "8: Criminal Justice")%>%
  select(-Pillar)

e2$Flag = cell_spec(e2$Flag, color = ifelse(e2$Flag == "Green", "green", ifelse(e2$Flag == "Red", "red", "gold")))


knitr::kable(e2, caption = "Variable List and Flags", booktabs = T, escape = F, digits=3)%>%
  kable_classic(html_font = "Arial", )%>%
  kable_styling(bootstrap_options = c("striped"), full_width = T)
  
```


### Overall {.tabset}

#### T-Test (Internal) Analysis

`r ttestex`

```{r}
b$Flag = cell_spec(b$Flag, color = ifelse(b$Flag == "Green", "green", ifelse(b$Flag == "Red", "red", "gold")))

knitr::kable(b, caption = "Variable List and Flags", booktabs = T, escape = F)%>%
  kable_classic(html_font = "Arial")%>%
  kable_styling(bootstrap_options = c("striped"))
```

#### Population Threshold (External) Analysis

`r threshex`

```{r}
a$Flag = cell_spec(a$Flag, color = ifelse(a$Flag == "Green", "green", ifelse(a$Flag == "Red", "red", "gold")))

knitr::kable(a, caption = "Variable List and Flags", booktabs = T, escape = F)%>%
  kable_classic(html_font = "Arial", )%>%
  kable_styling(bootstrap_options = c("striped"), full_width = T)
# %>%
#   scroll_box(width = "100%")
```


#### Experts Threshold (External) Analysis

`r threshex`

```{r}
e$Flag = cell_spec(e$Flag, color = ifelse(e$Flag == "Green", "green", ifelse(e$Flag == "Red", "red", "gold")))

knitr::kable(e, caption = "Variable List and Flags", booktabs = T, escape = F)%>%
  kable_classic(html_font = "Arial", )%>%
  kable_styling(bootstrap_options = c("striped"), full_width = T)

```


```{r}
# knitr::kable(appendix, caption = "Variable List and Flags")%>%
#   kable_classic(html_font = "Arial")%>%
#   kable_styling(bootstrap_options = c("striped"))
```


```{r, results = 'asis'}
# 
# flags2<- threshold%>%
#   group_by(Sub_Pillar, Pillar)%>%
#   count(Flag)%>%
#   pivot_wider(names_from = Flag, values_from = n)
# 
# flags2[is.na(flags2)] <- 0
# 
# ex<- c()
# 
# for (i in unique(flags2$Pillar)){
#   
#   pill<- filter(flags2, Pillar == i)
#   
#     red<- pill%>%
#       filter(red > 0)
#     
#     r<- ifelse(nrow(red)>2, paste0(", Sub-Pillars ", paste(red$Sub_Pillar[1:(nrow(red)-1)], sep="' '", collapse=", "), ", and ", red$Sub_Pillar[[nrow(red)]], " have "), ifelse(nrow(red) == 2, paste0(", Sub-Pillars ", red$Sub_Pillar[[1]], " and ", red$Sub_Pillar[[2]], " have "), ifelse(nrow(red) ==1, paste0(", Sub-Pillar ", red$Sub_Pillar[[1]], " has "), ifelse(nrow(red)== 0, ", no Sub-Pillars have "))))
#     
#     yellow<- pill%>%
#       filter(yellow > 0)%>%
#       filter(red == 0)
#     
#     y<- ifelse(nrow(yellow)>2, paste0(", Sub-Pillars ", paste(yellow$Sub_Pillar[1:(nrow(yellow)-1)], sep="' '", collapse=", "), ", and ", yellow$Sub_Pillar[[nrow(yellow)]], " have "), ifelse(nrow(yellow) == 2, paste0(", Sub-Pillars ", yellow$Sub_Pillar[[1]], " and ", yellow$Sub_Pillar[[2]], " have "), ifelse(nrow(yellow) ==1, paste0(", Sub-Pillar ", yellow$Sub_Pillar[[1]], " has "), ifelse(nrow(yellow)== 0, ", no Sub-Pillars have "))))
#     
#     green<- pill%>%
#       filter(green > 0)%>%
#       filter(red == 0)%>%
#       filter(yellow == 0)
#     
#     g<- ifelse(nrow(green)>2, paste0(" Sub-Pillars ", paste(green$Sub_Pillar[1:(nrow(green)-1)], sep="' '", collapse=", "), ", and ", green$Sub_Pillar[[nrow(green)]], " have "), ifelse(nrow(green) == 2, paste0(" Sub-Pillars ", green$Sub_Pillar[[1]], " and ", green$Sub_Pillar[[2]], " have "), ifelse(nrow(green) ==1, paste0(" Sub-Pillar ", green$Sub_Pillar[[1]], " has "), ifelse(nrow(green)== 0, " no Sub-Pillars have "))))
#     
#     ex<- c(ex, paste0("In Pillar ", i, r,  "high concern", y,  "moderate concern, and", g, "little to no concern."))
#     
# }
# 
#  
# text<- paste(ex, sep="", collapse="\n")
#cat(gsub(pattern = "\n", replacement = "  \n", x = text))
```

```{r}
# notes on T-test function

#produce dataframes through runme, outside of rmd, and call them in the rmd
#maybe make an excel with the GPP TPS matches so its not in the code

# we only have 17 variables to compare in t-test
# this is a problem because it is a small number

# flag country as problematic when it is flagged in both tests
# if only one, say "we only find it problematic in the threshold test/t-test"

#missing values function: count the number of people who answered more than 10% DK/PNTS
```




