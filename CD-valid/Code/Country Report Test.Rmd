---
title: "`r params$country` Validation Report"
author: "Dalia Habiby"
date: "2023-10-27"
output: html_document
params:
  country: "Czechia"
---

```{r setup, echo = F}

suppressMessages(library(tidyverse))
suppressMessages(library(haven))
suppressMessages(library(caret))
suppressMessages(library(rio))
suppressMessages(library(kableExtra))
knitr::opts_chunk$set(echo = F)

df<- import_list(paste0("../Outcomes/Pretest/", params$country, "/", params$country, ".xlsx"))
```


```{r}
threshold<- df$tps_comparisson
time<- df$time_changes
```

```{r}
# Threshold Analysis
flags<- threshold%>%
  group_by(Pillar)%>%
  count(Flag)

problematic<- c()
notproblematic<- c()

for (p in unique(threshold$Pillar)){
  
  pillar<- flags%>%
    filter(Pillar == p)
  
  sp<- sum(pillar$n)
  
  
  if ("red" %in% unique(pillar$Flag)){
  
    if (pillar$n[pillar$Flag == "red"]/sp >0.25 | (pillar$n[pillar$Flag == "red"] + pillar$n[pillar$Flag == "yellow"])/sp > 0.5){
      
      problematic<- c(problematic, p)
    
  }
    else {
      notproblematic<- c(notproblematic, p)

  }
    
  }
  
  else if ("yellow" %in% unique(pillar$Flag)){
    
    if (pillar$n[pillar$Flag == "yellow"]/sp > 0.5){
      
      problematic<- c(problematic, p)

    }
    else {
      notproblematic<- c(notproblematic, p)

  }
  
  }
  else {
    notproblematic<- c(notproblematic, p)

  }
  
}

clevel<- c()

if (length(problematic) >= length(c(problematic, notproblematic))/2){
  clevel<-c(clevel, 1)
} else {
  
  clevel<- c(clevel,0)
}






```

```{r}
# Time change analysis

time2<- time%>%
  rename(w = warning)

time2$warning <- if_else(time2$ttestResult < 0.01, "Red light", 
                        if_else(time2$ttestResult > 0.01 & time2$ttestResult > 0.1, "Yellow light", "Green light"))

warnings<- time2%>%
  group_by(pillar)%>%
  count(warning)

problematic<- c()
notproblematic<- c()

for (p in unique(time$pillar)){
  
  pillar<- warnings%>%
    filter(pillar == p)
  
  sp<- sum(pillar$n)
  
  
  if ("Red light" %in% unique(pillar$warning)){
  
    if (pillar$n[pillar$warning == "Red light"]/sp >0.25 ){
      
      problematic<- c(problematic, p)
    
    }
    
    else if ("Yellow light" %in% unique(pillar$warning)){
      
      if ((pillar$n[pillar$warning == "Red light"] + pillar$n[pillar$warning == "Yellow light"])/sp > 0.5){
        
        problematic<- c(problematic, p)
        
      }
      else {
        notproblematic<- c(notproblematic, p)
        
      }
    }
    
  }
  
  else if ("Yellow light" %in% unique(pillar$warning)){
    
    if (pillar$n[pillar$warning == "Yellow light"]/sp > 0.5){
      
      problematic<- c(problematic, p)

    }
    else {
      notproblematic<- c(notproblematic, p)

  }
  
  }
  else {
    notproblematic<- c(notproblematic, p)

  }
  
}

if (length(problematic) >= length(c(problematic, notproblematic))/2){
  clevel<-c(clevel, 1)
} else {
  
  clevel<- c(clevel,0)
}
```



```{r}
#Country overall

if (clevel[[1]] == 1 & clevel[[2]] == 1){
  
  probl<- "problematic"
  rec<- "we recommend that the survey company should be notified of this concern and instructed about how to remedy it."
  
} else if (clevel[[1]] == 1 & clevel[[2]] == 0) {
  probl<- "problematic only in the threshold analysis"
  rec<- "we recommend that the EU GPP team should decide whether to present any concern to the survey company."
} else if (clevel[[1]] == 0 & clevel[[2]] == 1){
  probl<- "problematic only in the time change analysis"
  rec<- "we recommend that the EU GPP team should decide whether to present any concern to the survey company."
  
} else if (clevel[[1]] == 0 & clevel[[2]] == 0){
  probl<- "not problematic"
  rec<- "we recommend that the EU GPP team continue monitoring and make note of any other concern"
  
}
```


## Country Level Findings

**We have found that the data from `r params$country` is `r probl`.**

Each country is evaluated based on two analyses: one external and the other internal. The first is a threshold difference between a few EU GPP indicators and their matched third party source indicators for each sub-pillar. 

We define a pillar as problematic in the threshold analysis in one of two cases:
  
1. If 25% or more of the sub-pillars have a threshold difference above 0.25 (red flag), or
  
2. If 50% or more of the sub-pillars have a threshold difference above 0.10 (yellow flag)
  
The second analysis is a t-test between a few EU GPP indicators and their counterparts from the latest Global GPP per country. 
  
We define a pillar as problematic in the t-test analysis in one of two cases:
  
1. If 25% or more of the indicators have a statistically significant difference from our last GPP with a p-value below 0.01 (red flag)
  
2. If 50% or more of the indicators have a statistically significant difference from our last GPP with a p-value below 0.1 (yellow flag)

In each test, we flag the country as a whole if at lease half of the Pillars evaluated are labelled "problematic." If the country is labelled "problematic" in both tests, then we find cause for concern. 

Since the data from `r params$country` is overall `r probl`, `r rec`


```{r}
flagsoutput<- flags%>%
  pivot_wider(names_from = Flag, values_from = n)

flagsoutput[is.na(flagsoutput)] <- 0
  
flagsoutput<- flagsoutput%>%
  mutate(sum = green + red + yellow )%>%
  select(Pillar, green, yellow, red, sum)

flagsoutput$Label<- ifelse(flagsoutput$red> flagsoutput$sum/4, "Problematic", ifelse(flagsoutput$red+flagsoutput$yellow > flagsoutput$sum/2, "Problematic", ifelse(flagsoutput$yellow > flagsoutput$sum/2, "Problematic", "Not Problematic")))


colnames(flagsoutput)<- c("Pillar", "Green Flags", "Yellow Flags", "Red Flags", "Total Indicators", "Label")



```

## Pillar and Sub-Pillar Details

Below are two tables summarizing each of the validation analyses to provide further details about the issues we have flagged. If you are interested in exploring which specific variables are flagged, please see the Appendix below.
  
Given the nature of third party sources, there are a limited number of external indicators that match with our EU GPP indicators. As of now, we do not have any matches for Pillar 6. Furthermore, all of the third party indicators may not be available for each country and thus the total indicators in each Pillar may vary. 

```{r}
knitr::kable(flagsoutput, caption = "Threshold Analysis Summary")%>%
  kable_classic(html_font = "Arial")%>%
  kable_styling(bootstrap_options = c("striped"))

```


```{r}
warningsoutput<- warnings%>%
  pivot_wider(names_from = warning, values_from = n)

warningsoutput[is.na(warningsoutput)] <- 0
  
warningsoutput<- warningsoutput%>%
  mutate(sum = `Green light` + `Red light` + `Yellow light`)%>%
  select(pillar, `Green light`, `Yellow light`, `Red light`, sum)

warningsoutput$Label<- ifelse(warningsoutput$`Red light`> warningsoutput$sum/4, "Problematic", ifelse(warningsoutput$`Red light`+warningsoutput$`Yellow light` > warningsoutput$sum/2, "Problematic", ifelse(warningsoutput$`Yellow light` > warningsoutput$sum/2, "Problematic", "Not Problematic")))


colnames(warningsoutput)<- c("Pillar", "Green Flags", "Yellow Flags", "Red Flags", "Total Indicators", "Label")

```

  
Since the t-test analysis this year is comparing to the previous Global GPP, there are some indicators that are new this year and do not match with the Global indicators. Therefore, there are less indicators evaluated in this analysis than the threshold analysis. Additionally, we expect many of our indicators to change in significant ways as the world changes. Therefore, it is up to the discretion of the EU GPP team whether or not the t-test results are concerning.

```{r}
knitr::kable(warningsoutput, caption = "T-Test Analysis Summary")%>%
  kable_classic(html_font = "Arial")%>%
  kable_styling(bootstrap_options = c("striped"))
```


## Appendix

```{r}
th<- threshold%>%
  select(Country, GPP_Variable_Name, Flag, Pillar, Sub_Pillar)
tt<- time2%>%
  select(variable, warning)

appendix<- left_join(th, tt, by = join_by("GPP_Variable_Name"== variable), relationship = "many-to-many")
appendix$Sub_Pillar<- as.numeric(appendix$Sub_Pillar)
appendix<- appendix%>%
  select(Country, GPP_Variable_Name, Flag, warning, Pillar, Sub_Pillar)%>%
  distinct()%>%
  arrange(GPP_Variable_Name, Sub_Pillar)

appendix$Flag<- ifelse(appendix$Flag == "red", "Red", ifelse(appendix$Flag == "yellow", "Yellow", ifelse(appendix$Flag == "green", "Green", "Not Assessed")))
appendix$warning<- ifelse(appendix$warning == "Red light", "Red", ifelse(appendix$warning == "Yellow light", "Yellow", ifelse(appendix$warning == "Green light", "Green", "Not Assessed")))

colnames(appendix)<- c("Country", "GPP Variable Name", "Flag Threshold", "Flag T-Test", "Pillar", "Sub-Pillar")


```


```{r}
knitr::kable(appendix, caption = "Variable List and Flags")%>%
  kable_classic(html_font = "Arial")%>%
  kable_styling(bootstrap_options = c("striped"))
```


```{r, results = 'asis'}

flags2<- threshold%>%
  group_by(Sub_Pillar, Pillar)%>%
  count(Flag)%>%
  pivot_wider(names_from = Flag, values_from = n)

flags2[is.na(flags2)] <- 0

ex<- c()

for (i in unique(flags2$Pillar)){
  
  pill<- filter(flags2, Pillar == i)
  
    red<- pill%>%
      filter(red > 0)
    
    r<- ifelse(nrow(red)>2, paste0(", Sub-Pillars ", paste(red$Sub_Pillar[1:(nrow(red)-1)], sep="' '", collapse=", "), ", and ", red$Sub_Pillar[[nrow(red)]], " have "), ifelse(nrow(red) == 2, paste0(", Sub-Pillars ", red$Sub_Pillar[[1]], " and ", red$Sub_Pillar[[2]], " have "), ifelse(nrow(red) ==1, paste0(", Sub-Pillar ", red$Sub_Pillar[[1]], " has "), ifelse(nrow(red)== 0, ", no Sub-Pillars have "))))
    
    yellow<- pill%>%
      filter(yellow > 0)%>%
      filter(red == 0)
    
    y<- ifelse(nrow(yellow)>2, paste0(", Sub-Pillars ", paste(yellow$Sub_Pillar[1:(nrow(yellow)-1)], sep="' '", collapse=", "), ", and ", yellow$Sub_Pillar[[nrow(yellow)]], " have "), ifelse(nrow(yellow) == 2, paste0(", Sub-Pillars ", yellow$Sub_Pillar[[1]], " and ", yellow$Sub_Pillar[[2]], " have "), ifelse(nrow(yellow) ==1, paste0(", Sub-Pillar ", yellow$Sub_Pillar[[1]], " has "), ifelse(nrow(yellow)== 0, ", no Sub-Pillars have "))))
    
    green<- pill%>%
      filter(green > 0)%>%
      filter(red == 0)%>%
      filter(yellow == 0)
    
    g<- ifelse(nrow(green)>2, paste0(" Sub-Pillars ", paste(green$Sub_Pillar[1:(nrow(green)-1)], sep="' '", collapse=", "), ", and ", green$Sub_Pillar[[nrow(green)]], " have "), ifelse(nrow(green) == 2, paste0(" Sub-Pillars ", green$Sub_Pillar[[1]], " and ", green$Sub_Pillar[[2]], " have "), ifelse(nrow(green) ==1, paste0(" Sub-Pillar ", green$Sub_Pillar[[1]], " has "), ifelse(nrow(green)== 0, " no Sub-Pillars have "))))
    
    ex<- c(ex, paste0("In Pillar ", i, r,  "high concern", y,  "moderate concern, and", g, "little to no concern."))
    
}

 
text<- paste(ex, sep="", collapse="\n")
#cat(gsub(pattern = "\n", replacement = "  \n", x = text))
```

```{r}
# notes on T-test function

#produce dataframes through runme, outside of rmd, and call them in the rmd
#maybe make an excel with the GPP TPS matches so its not in the code

# we only have 17 variables to compare in t-test
# this is a problem because it is a small number

# flag country as problematic when it is flagged in both tests
# if only one, say "we only find it problematic in the threshold test/t-test"

#missing values function: count the number of people who answered more than 10% DK/PNTS
```




